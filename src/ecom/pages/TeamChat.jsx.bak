// REWRITE
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useEcomAuth } from '../hooks/useEcomAuth.jsx';


const EMOJIS = ['ðŸ’¬','ðŸ“¦','ðŸ’°','ðŸšš','ðŸ­','ðŸ“£','ðŸ“Š','ðŸŽ¯','ðŸ””','âš¡','ðŸ›’','ðŸ‘¥','ðŸ“','ðŸ”§','ðŸŒŸ'];

const renderContent = (content, own) => {
  const parts = content.split(/(@\S+)/g);
  return parts.map((part, i) =>
    part.startsWith('@')
      ? <span key={i} className={`font-semibold ${own ? 'text-blue-100 bg-blue-500' : 'text-blue-700 bg-blue-50'} px-1 rounded`}>{part}</span>
      : part
  );
};

const ROLE_COLORS = {
  ecom_admin: 'bg-blue-600',
  ecom_closeuse: 'bg-pink-500',
  ecom_compta: 'bg-emerald-500',
  ecom_livreur: 'bg-orange-500',
  super_admin: 'bg-purple-600'
};

const ROLE_LABELS = {
  ecom_admin: 'Admin',
  ecom_closeuse: 'Closeuse',
  ecom_compta: 'Compta',
  ecom_livreur: 'Livreur',
  super_admin: 'Super Admin'
};

const formatTime = (dateStr) => {
  const date = new Date(dateStr);
  const now = new Date();
  const dayDiff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
  if (dayDiff === 0) return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  if (dayDiff === 1) return `Hier ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
};

const getInitial = (name) => (name || 'U').charAt(0).toUpperCase();

export default function TeamChat() {
  const { user } = useEcomAuth();
  const [channels, setChannels] = useState([]);
  const [unreadCounts, setUnreadCounts] = useState({});
  const [activeChannel, setActiveChannel] = useState(null);
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);
  const [replyTo, setReplyTo] = useState(null);
  const [editingId, setEditingId] = useState(null);
  const [editContent, setEditContent] = useState('');
  const [members, setMembers] = useState([]);
  const [showMembers, setShowMembers] = useState(false);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(false);
  const [loadingMore, setLoadingMore] = useState(false);
  const [showNewChannel, setShowNewChannel] = useState(false);
  const [newChannelName, setNewChannelName] = useState('');
  const [newChannelEmoji, setNewChannelEmoji] = useState('ðŸ’¬');
  const [newChannelDesc, setNewChannelDesc] = useState('');
  const [creatingChannel, setCreatingChannel] = useState(false);
  const [mentionQuery, setMentionQuery] = useState('');
  const [showMentions, setShowMentions] = useState(false);
  const [mentionIndex, setMentionIndex] = useState(0);
  // DM
  const [mode, setMode] = useState('channels'); // 'channels' | 'dm'
  const [dmConversations, setDmConversations] = useState([]);
  const [activeDmUser, setActiveDmUser] = useState(null); // { _id, name, role }
  const [dmMessages, setDmMessages] = useState([]);
  const [dmNewMessage, setDmNewMessage] = useState('');
  const [dmSending, setDmSending] = useState(false);
  const [dmLoading, setDmLoading] = useState(false);
  const [dmUnread, setDmUnread] = useState(0);
  const [showNewDm, setShowNewDm] = useState(false);

  const messagesEndRef = useRef(null);
  const dmEndRef = useRef(null);
  const inputRef = useRef(null);
  const dmInputRef = useRef(null);
  const pollRef = useRef(null);
  const dmPollRef = useRef(null);
  const lastMessageIdRef = useRef(null);
  const lastDmIdRef = useRef(null);
  const token = localStorage.getItem('ecomToken');

  const apiFetch = useCallback(async (path, options = {}) => {
    const res = await fetch(`/api/ecom/messages${path}`, {
      ...options,
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}`, ...options.headers }
    });
    return res.json();
  }, [token]);

  const dmFetch = useCallback(async (path, options = {}) => {
    const res = await fetch(`/api/ecom/dm${path}`, {
      ...options,
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}`, ...options.headers }
    });
    return res.json();
  }, [token]);

  const loadChannels = useCallback(async () => {
    try {
      const data = await apiFetch('/channels');
      if (data.success) {
        setChannels(data.channels);
        setUnreadCounts(data.unreadCounts || {});
        if (!activeChannel && data.channels.length > 0) setActiveChannel(data.channels[0].slug);
      }
    } catch (err) { console.error(err); }
  }, [apiFetch, activeChannel]);

  const loadMessages = useCallback(async (channel, pageNum = 1, append = false) => {
    try {
      if (pageNum === 1) setLoading(true); else setLoadingMore(true);
      const data = await apiFetch(`/${channel}?page=${pageNum}&limit=50`);
      if (data.success) {
        if (append) setMessages(prev => [...data.messages, ...prev]);
        else {
          setMessages(data.messages);
          lastMessageIdRef.current = data.messages[data.messages.length - 1]?._id;
          setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
        }
        setHasMore(data.pagination.page < data.pagination.pages);
        setPage(pageNum);
        setUnreadCounts(prev => ({ ...prev, [channel]: 0 }));
      }
    } catch (err) { console.error(err); }
    finally { setLoading(false); setLoadingMore(false); }
  }, [apiFetch]);

  const pollMessages = useCallback(async () => {
    try {
      const data = await apiFetch(`/${activeChannel}?page=1&limit=50`);
      if (data.success && data.messages.length > 0) {
        const latestId = data.messages[data.messages.length - 1]?._id;
        if (latestId !== lastMessageIdRef.current) {
          setMessages(data.messages);
          lastMessageIdRef.current = latestId;
          setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
        }
      }
      const cd = await apiFetch('/channels');
      if (cd.success) setUnreadCounts(cd.unreadCounts || {});
    } catch (_) {}
  }, [apiFetch, activeChannel]);

  const loadMembers = useCallback(async () => {
    try {
      const data = await apiFetch('/team/members');
      if (data.success) setMembers(data.members);
    } catch (err) { console.error(err); }
  }, [apiFetch]);

  const loadDmConversations = useCallback(async () => {
    try {
      const data = await dmFetch('/conversations');
      if (data.success) setDmConversations(data.conversations);
    } catch (_) {}
  }, [dmFetch]);

  const loadDmMessages = useCallback(async (userId) => {
    if (!userId) return;
    setDmLoading(true);
    try {
      const data = await dmFetch(`/${userId}?limit=50`);
      if (data.success) {
        setDmMessages(data.messages);
        lastDmIdRef.current = data.messages[data.messages.length - 1]?._id;
        setTimeout(() => dmEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
      }
    } catch (_) {}
    finally { setDmLoading(false); }
  }, [dmFetch]);

  const sendDm = async (e) => {
    e.preventDefault();
    if (!dmNewMessage.trim() || dmSending || !activeDmUser) return;
    setDmSending(true);
    try {
      const data = await dmFetch(`/${activeDmUser._id}`, {
        method: 'POST',
        body: JSON.stringify({ content: dmNewMessage.trim() })
      });
      if (data.success) {
        setDmMessages(prev => [...prev, data.message]);
        setDmNewMessage('');
        lastDmIdRef.current = data.message._id;
        setTimeout(() => dmEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 50);
        loadDmConversations();
      }
    } catch (_) {}
    finally { setDmSending(false); dmInputRef.current?.focus(); }
  };

  const deleteDm = async (msgId) => {
    if (!window.confirm('Supprimer ce message ?')) return;
    try {
      await dmFetch(`/message/${msgId}`, { method: 'DELETE' });
      setDmMessages(prev => prev.filter(m => m._id !== msgId));
    } catch (_) {}
  };

  const pollDm = useCallback(async () => {
    if (!activeDmUser) return;
    try {
      const data = await dmFetch(`/${activeDmUser._id}?limit=50`);
      if (data.success && data.messages.length > 0) {
        const latestId = data.messages[data.messages.length - 1]?._id;
        if (latestId !== lastDmIdRef.current) {
          setDmMessages(data.messages);
          lastDmIdRef.current = latestId;
          setTimeout(() => dmEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
        }
      }
      const uc = await dmFetch('/unread/count');
      if (uc.success) setDmUnread(uc.count);
    } catch (_) {}
  }, [dmFetch, activeDmUser]);

  useEffect(() => { loadChannels(); loadMembers(); loadDmConversations(); }, [loadChannels, loadMembers, loadDmConversations]);

  useEffect(() => {
    if (!activeChannel) return;
    loadMessages(activeChannel, 1, false);
    clearInterval(pollRef.current);
    pollRef.current = setInterval(pollMessages, 5000);
    return () => clearInterval(pollRef.current);
  }, [activeChannel, loadMessages, pollMessages]);

  useEffect(() => {
    if (!activeDmUser) return;
    loadDmMessages(activeDmUser._id);
    clearInterval(dmPollRef.current);
    dmPollRef.current = setInterval(pollDm, 5000);
    return () => clearInterval(dmPollRef.current);
  }, [activeDmUser, loadDmMessages, pollDm]);

  const sendMessage = async (e) => {
    e.preventDefault();
    if (!newMessage.trim() || sending) return;
    setSending(true);
    try {
      const data = await apiFetch(`/${activeChannel}`, {
        method: 'POST',
        body: JSON.stringify({ content: newMessage.trim(), replyTo: replyTo?._id || null })
      });
      if (data.success) {
        setMessages(prev => [...prev, data.message]);
        setNewMessage(''); setReplyTo(null);
        lastMessageIdRef.current = data.message._id;
        setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 50);
      }
    } catch (err) { console.error(err); }
    finally { setSending(false); inputRef.current?.focus(); }
  };

  const saveEdit = async (messageId) => {
    if (!editContent.trim()) return;
    try {
      const data = await apiFetch(`/${activeChannel}/${messageId}`, { method: 'PUT', body: JSON.stringify({ content: editContent.trim() }) });
      if (data.success) { setMessages(prev => prev.map(m => m._id === messageId ? data.message : m)); setEditingId(null); setEditContent(''); }
    } catch (err) { console.error(err); }
  };

  const deleteMessage = async (messageId) => {
    if (!window.confirm('Supprimer ce message ?')) return;
    try {
      const data = await apiFetch(`/${activeChannel}/${messageId}`, { method: 'DELETE' });
      if (data.success) setMessages(prev => prev.filter(m => m._id !== messageId));
    } catch (err) { console.error(err); }
  };

  const handleMentionInput = (value) => {
    setNewMessage(value);
    const atIdx = value.lastIndexOf('@');
    if (atIdx !== -1) {
      const afterAt = value.slice(atIdx + 1);
      if (afterAt.match(/^[\w\s]{0,20}$/) && !afterAt.includes(' ')) {
        setMentionQuery(afterAt);
        setShowMentions(true);
        setMentionIndex(0);
        return;
      }
    }
    setShowMentions(false);
  };

  const filteredMentions = members.filter(m =>
    (m.name || m.email || '').toLowerCase().includes(mentionQuery.toLowerCase())
  ).slice(0, 6);

  const insertMention = (member) => {
    const atIdx = newMessage.lastIndexOf('@');
    const name = member.name || member.email?.split('@')[0] || 'membre';
    setNewMessage(newMessage.slice(0, atIdx) + `@${name} `);
    setShowMentions(false);
    inputRef.current?.focus();
  };

  const handleKeyDown = (e) => {
    if (showMentions && filteredMentions.length > 0) {
      if (e.key === 'ArrowDown') { e.preventDefault(); setMentionIndex(i => Math.min(i + 1, filteredMentions.length - 1)); return; }
      if (e.key === 'ArrowUp') { e.preventDefault(); setMentionIndex(i => Math.max(i - 1, 0)); return; }
      if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); insertMention(filteredMentions[mentionIndex]); return; }
      if (e.key === 'Escape') { setShowMentions(false); return; }
    }
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(e); }
    if (e.key === 'Escape') { setReplyTo(null); setEditingId(null); }
  };

  const isOwnMessage = (msg) => {
    const sid = msg.senderId?._id || msg.senderId;
    return sid?.toString() === user?._id?.toString();
  };

  const isAdmin = ['ecom_admin', 'super_admin'].includes(user?.role);

  const createChannel = async (e) => {
    e.preventDefault();
    if (!newChannelName.trim() || creatingChannel) return;
    setCreatingChannel(true);
    try {
      const data = await apiFetch('/channels', {
        method: 'POST',
        body: JSON.stringify({ name: newChannelName.trim(), emoji: newChannelEmoji, description: newChannelDesc.trim() })
      });
      if (data.success) {
        setShowNewChannel(false);
        setNewChannelName(''); setNewChannelEmoji('ðŸ’¬'); setNewChannelDesc('');
        await loadChannels();
        setActiveChannel(data.channel.slug);
      } else { alert(data.message || 'Erreur'); }
    } catch (err) { console.error(err); }
    finally { setCreatingChannel(false); }
  };

  const deleteChannel = async (slug) => {
    if (!window.confirm('Supprimer ce canal et tous ses messages ?')) return;
    try {
      await apiFetch(`/channels/${slug}`, { method: 'DELETE' });
      await loadChannels();
      if (activeChannel === slug) setActiveChannel(channels.find(c => c.slug !== slug)?.slug || '');
    } catch (err) { console.error(err); }
  };

  const activeChannelObj = channels.find(c => c.slug === activeChannel);

  return (
    <div className="flex h-[calc(100vh-56px)] bg-gray-50 overflow-hidden">
      {/* Sidebar */}
      <div className="w-60 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
        <div className="p-4 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-base font-semibold text-gray-900 flex items-center gap-2">
            <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            Chat Ã‰quipe
          </h2>
        </div>
        <nav className="flex-1 overflow-y-auto p-2 space-y-0.5">
          <div className="flex items-center justify-between px-2 py-1.5">
            <p className="text-xs font-medium text-gray-400 uppercase">Canaux</p>
            <button onClick={() => setShowNewChannel(true)} title="Nouveau canal"
              className="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors">
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
            </button>
          </div>
          {channels.length === 0 ? (
            <div className="px-3 py-6 text-center">
              <p className="text-xs text-gray-400">Aucun canal</p>
              <button onClick={() => setShowNewChannel(true)} className="mt-2 text-xs text-blue-600 hover:underline">CrÃ©er le premier canal</button>
            </div>
          ) : channels.map(ch => {
            const unread = unreadCounts[ch.slug] || 0;
            return (
              <div key={ch.slug} className="group relative">
                <button onClick={() => setActiveChannel(ch.slug)}
                  className={`w-full flex items-center gap-2.5 px-3 py-2 rounded-lg text-sm transition-colors ${activeChannel === ch.slug ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}>
                  <span className="text-base">{ch.emoji}</span>
                  <div className="flex-1 text-left min-w-0">
                    <div className="flex items-center justify-between">
                      <span className="truncate">{ch.name}</span>
                      {unread > 0 && <span className="ml-1 min-w-[18px] h-[18px] flex items-center justify-center px-1 rounded-full bg-blue-600 text-white text-[10px] font-bold">{unread > 99 ? '99+' : unread}</span>}
                    </div>
                    {ch.description && <p className="text-[10px] text-gray-400 truncate">{ch.description}</p>}
                  </div>
                </button>
                {isAdmin && (
                  <button onClick={() => deleteChannel(ch.slug)}
                    className="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 p-1 text-gray-300 hover:text-red-500 rounded transition-all">
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                )}
              </div>
            );
          })}
        </nav>
        {/* Section Messages Directs */}
        <div className="border-t border-gray-200 pt-1 pb-2">
          <div className="flex items-center justify-between px-2 py-1.5">
            <p className="text-xs font-medium text-gray-400 uppercase">Messages directs</p>
            <button onClick={() => setShowNewDm(!showNewDm)} title="Nouveau message direct"
              className="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors">
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
            </button>
          </div>
          {showNewDm && (
            <div className="px-2 pb-1 space-y-0.5 max-h-36 overflow-y-auto">
              {members.filter(m => m._id !== user?._id).map(m => (
                <button key={m._id} onClick={() => { setActiveDmUser(m); setMode('dm'); setShowNewDm(false); }}
                  className="w-full flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-blue-50 transition-colors text-left">
                  <div className={`w-6 h-6 ${ROLE_COLORS[m.role] || 'bg-gray-400'} rounded-full flex items-center justify-center flex-shrink-0`}>
                    <span className="text-white text-[10px] font-bold">{getInitial(m.name)}</span>
                  </div>
                  <div className="min-w-0">
                    <p className="text-xs font-medium text-gray-800 truncate">{m.name || m.email?.split('@')[0]}</p>
                    <p className="text-[10px] text-gray-400">{ROLE_LABELS[m.role] || m.role}</p>
                  </div>
                </button>
              ))}
            </div>
          )}
          <div className="px-2 space-y-0.5">
            {dmConversations.map(conv => {
              const other = conv.other;
              if (!other) return null;
              const isActive = mode === 'dm' && activeDmUser?._id === other._id;
              return (
                <button key={conv._id} onClick={() => { setActiveDmUser(other); setMode('dm'); setShowNewDm(false); }}
                  className={`w-full flex items-center gap-2 px-2 py-1.5 rounded-lg text-sm transition-colors ${isActive ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                  <div className={`w-6 h-6 ${ROLE_COLORS[other.role] || 'bg-gray-400'} rounded-full flex items-center justify-center flex-shrink-0`}>
                    <span className="text-white text-[10px] font-bold">{getInitial(other.name)}</span>
                  </div>
                  <div className="flex-1 text-left min-w-0">
                    <div className="flex items-center justify-between">
                      <span className="text-xs font-medium truncate">{other.name || other.email?.split('@')[0]}</span>
                      {conv.unread > 0 && <span className="min-w-[16px] h-4 flex items-center justify-center px-1 rounded-full bg-blue-600 text-white text-[9px] font-bold">{conv.unread}</span>}
                    </div>
                    <p className="text-[10px] text-gray-400 truncate">{conv.lastMessage?.content}</p>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      </div>

      {/* Zone principale */}
      <div className="flex-1 flex flex-col min-w-0">

        {/* ===== VUE DM ===== */}
        {mode === 'dm' && activeDmUser && (
          <>
            <div className="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between flex-shrink-0">
              <div className="flex items-center gap-3">
                <button onClick={() => setMode('channels')} className="p-1 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div className={`w-8 h-8 ${ROLE_COLORS[activeDmUser.role] || 'bg-gray-400'} rounded-full flex items-center justify-center`}>
                  <span className="text-white text-xs font-bold">{getInitial(activeDmUser.name)}</span>
                </div>
                <div>
                  <h3 className="font-semibold text-gray-900">{activeDmUser.name || activeDmUser.email?.split('@')[0]}</h3>
                  <p className="text-xs text-gray-500">{ROLE_LABELS[activeDmUser.role] || activeDmUser.role} Â· Message privÃ©</p>
                </div>
              </div>
              <button onClick={() => loadDmMessages(activeDmUser._id)} className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100" title="RafraÃ®chir">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
              </button>
            </div>

            <div className="flex-1 overflow-y-auto px-4 py-4 space-y-1">
              {dmLoading ? (
                <div className="flex items-center justify-center h-full">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
              ) : dmMessages.length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <div className="text-center">
                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                      <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                    </div>
                    <p className="text-gray-500 font-medium">DÃ©marrez la conversation</p>
                    <p className="text-sm text-gray-400 mt-1">Envoyez un message Ã  {activeDmUser.name}</p>
                  </div>
                </div>
              ) : dmMessages.map((msg, idx) => {
                const own = msg.senderId?.toString() === user?._id?.toString() || msg.senderId?._id?.toString() === user?._id?.toString();
                const prevMsg = dmMessages[idx - 1];
                const sameAuthor = prevMsg && (prevMsg.senderId?._id || prevMsg.senderId)?.toString() === (msg.senderId?._id || msg.senderId)?.toString();
                const timeDiff = prevMsg ? new Date(msg.createdAt) - new Date(prevMsg.createdAt) : Infinity;
                const showHeader = !sameAuthor || timeDiff > 5 * 60 * 1000;
                return (
                  <div key={msg._id} className={`flex gap-2.5 ${own ? 'flex-row-reverse' : 'flex-row'} ${showHeader ? 'mt-4' : 'mt-0.5'} group`}>
                    {showHeader ? (
                      <div className={`w-8 h-8 ${ROLE_COLORS[msg.senderRole] || 'bg-gray-400'} rounded-full flex items-center justify-center flex-shrink-0 mt-0.5`}>
                        <span className="text-white text-xs font-bold">{getInitial(msg.senderName)}</span>
                      </div>
                    ) : <div className="w-8 flex-shrink-0" />}
                    <div className={`max-w-[70%] flex flex-col ${own ? 'items-end' : 'items-start'}`}>
                      {showHeader && (
                        <div className={`flex items-center gap-2 mb-1 ${own ? 'flex-row-reverse' : 'flex-row'}`}>
                          <span className="text-xs font-semibold text-gray-800">{own ? 'Vous' : msg.senderName}</span>
                          <span className="text-[10px] text-gray-400">{formatTime(msg.createdAt)}</span>
                        </div>
                      )}
                      <div className={`px-3.5 py-2 rounded-2xl text-sm leading-relaxed break-words ${own ? 'bg-blue-600 text-white rounded-tr-sm' : 'bg-white text-gray-800 border border-gray-200 rounded-tl-sm shadow-sm'}`}>
                        {renderContent(msg.content, own)}
                      </div>
                      {!showHeader && <span className="text-[10px] text-gray-400 mt-0.5 opacity-0 group-hover:opacity-100 transition-opacity">{formatTime(msg.createdAt)}</span>}
                    </div>
                    <div className={`flex items-center opacity-0 group-hover:opacity-100 transition-opacity self-center ${own ? 'flex-row' : 'flex-row-reverse'}`}>
                      {own && (
                        <button onClick={() => deleteDm(msg._id)} className="p-1 text-gray-400 hover:text-red-500 rounded hover:bg-red-50" title="Supprimer">
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
              <div ref={dmEndRef} />
            </div>

            <div className="bg-white border-t border-gray-200 p-4 flex-shrink-0">
              <form onSubmit={sendDm} className="flex items-end gap-2">
                <textarea
                  ref={dmInputRef}
                  value={dmNewMessage}
                  onChange={e => setDmNewMessage(e.target.value)}
                  onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDm(e); } }}
                  placeholder={`Message privÃ© Ã  ${activeDmUser.name}...`}
                  className="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none leading-relaxed"
                  rows={1}
                  style={{ minHeight: '42px', maxHeight: '120px' }}
                  onInput={e => { e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px'; }}
                />
                <button type="submit" disabled={!dmNewMessage.trim() || dmSending}
                  className="flex-shrink-0 w-10 h-10 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white rounded-xl flex items-center justify-center transition-colors">
                  {dmSending ? <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" /> : <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>}
                </button>
              </form>
              <p className="text-[10px] text-gray-400 mt-1.5 ml-1">EntrÃ©e pour envoyer Â· Maj+EntrÃ©e pour nouvelle ligne</p>
            </div>
          </>
        )}

        {/* ===== VUE CANAL ===== */}
        {mode === 'channels' && (
        <>
        <div className="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between flex-shrink-0">
          <div className="flex items-center gap-3">
            <span className="text-xl">{activeChannelObj?.emoji || 'ðŸ’¬'}</span>
            <div>
              <h3 className="font-semibold text-gray-900">{activeChannelObj?.name || activeChannel || 'Aucun canal'}</h3>
              <p className="text-xs text-gray-500">{activeChannelObj?.description || ''}{activeChannelObj?.description ? ' Â· ' : ''}{messages.length} messages</p>
            </div>
          </div>
          <button onClick={() => activeChannel && loadMessages(activeChannel, 1, false)} className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100" title="RafraÃ®chir">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
          </button>
        </div>

        <div className="flex-1 overflow-y-auto px-4 py-4 space-y-1">
          {hasMore && (
            <div className="flex justify-center mb-4">
              <button onClick={() => loadMessages(activeChannel, page + 1, true)} disabled={loadingMore}
                className="text-sm text-blue-600 hover:text-blue-700 font-medium px-4 py-1.5 rounded-full border border-blue-200 hover:bg-blue-50 disabled:opacity-50">
                {loadingMore ? 'Chargement...' : 'Charger plus'}
              </button>
            </div>
          )}

          {loading ? (
            <div className="flex items-center justify-center h-full">
              <div className="text-center">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p className="mt-2 text-sm text-gray-500">Chargement...</p>
              </div>
            </div>
          ) : messages.length === 0 ? (
            <div className="flex items-center justify-center h-full">
              <div className="text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                  <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                </div>
                <p className="text-gray-500 font-medium">Aucun message</p>
                <p className="text-sm text-gray-400 mt-1">Soyez le premier Ã  Ã©crire !</p>
              </div>
            </div>
          ) : (
            <>
              {messages.map((msg, idx) => {
                const own = isOwnMessage(msg);
                const prevMsg = messages[idx - 1];
                const sameAuthor = prevMsg && (prevMsg.senderId?._id || prevMsg.senderId)?.toString() === (msg.senderId?._id || msg.senderId)?.toString();
                const timeDiff = prevMsg ? new Date(msg.createdAt) - new Date(prevMsg.createdAt) : Infinity;
                const showHeader = !sameAuthor || timeDiff > 5 * 60 * 1000;

                return (
                  <div key={msg._id} className={`flex gap-2.5 ${own ? 'flex-row-reverse' : 'flex-row'} ${showHeader ? 'mt-4' : 'mt-0.5'} group`}>
                    {showHeader ? (
                      <div className={`w-8 h-8 ${ROLE_COLORS[msg.senderRole] || 'bg-gray-400'} rounded-full flex items-center justify-center flex-shrink-0 mt-0.5`}>
                        <span className="text-white text-xs font-bold">{getInitial(msg.senderName)}</span>
                      </div>
                    ) : <div className="w-8 flex-shrink-0" />}

                    <div className={`max-w-[70%] flex flex-col ${own ? 'items-end' : 'items-start'}`}>
                      {showHeader && (
                        <div className={`flex items-center gap-2 mb-1 ${own ? 'flex-row-reverse' : 'flex-row'}`}>
                          <span className="text-xs font-semibold text-gray-800">{msg.senderName}</span>
                          <span className={`text-[10px] px-1.5 py-0.5 rounded-full text-white ${ROLE_COLORS[msg.senderRole] || 'bg-gray-400'}`}>{ROLE_LABELS[msg.senderRole] || msg.senderRole}</span>
                          <span className="text-[10px] text-gray-400">{formatTime(msg.createdAt)}</span>
                        </div>
                      )}

                      {msg.replyToContent && (
                        <div className={`mb-1 px-3 py-1.5 rounded-lg border-l-2 border-blue-400 bg-blue-50 text-xs text-gray-600 max-w-full`}>
                          <p className="font-medium text-blue-600 mb-0.5">{msg.replyToSenderName}</p>
                          <p className="truncate">{msg.replyToContent}</p>
                        </div>
                      )}

                      {editingId === msg._id ? (
                        <div className="w-full min-w-[200px]">
                          <textarea value={editContent} onChange={e => setEditContent(e.target.value)}
                            onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); saveEdit(msg._id); } if (e.key === 'Escape') { setEditingId(null); setEditContent(''); } }}
                            className="w-full px-3 py-2 border border-blue-400 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows={2} autoFocus />
                          <div className="flex gap-2 mt-1 justify-end">
                            <button onClick={() => { setEditingId(null); setEditContent(''); }} className="text-xs text-gray-500 hover:text-gray-700">Annuler</button>
                            <button onClick={() => saveEdit(msg._id)} className="text-xs text-blue-600 font-medium hover:text-blue-700">Sauvegarder</button>
                          </div>
                        </div>
                      ) : (
                        <div className={`px-3.5 py-2 rounded-2xl text-sm leading-relaxed break-words ${own ? 'bg-blue-600 text-white rounded-tr-sm' : 'bg-white text-gray-800 border border-gray-200 rounded-tl-sm shadow-sm'}`}>
                          {renderContent(msg.content, own)}
                          {msg.edited && <span className={`text-[10px] ml-1.5 ${own ? 'text-blue-200' : 'text-gray-400'}`}>(modifiÃ©)</span>}
                        </div>
                      )}

                      {!showHeader && (
                        <span className="text-[10px] text-gray-400 mt-0.5 opacity-0 group-hover:opacity-100 transition-opacity">{formatTime(msg.createdAt)}</span>
                      )}
                    </div>

                    <div className={`flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity self-center ${own ? 'flex-row' : 'flex-row-reverse'}`}>
                      <button onClick={() => setReplyTo(msg)} className="p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100" title="RÃ©pondre">
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
                      </button>
                      {isOwnMessage(msg) && (
                        <button onClick={() => { setEditingId(msg._id); setEditContent(msg.content); }} className="p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100" title="Modifier">
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                      )}
                      {(isOwnMessage(msg) || isAdmin) && (
                        <button onClick={() => deleteMessage(msg._id)} className="p-1 text-gray-400 hover:text-red-500 rounded hover:bg-red-50" title="Supprimer">
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
              <div ref={messagesEndRef} />
            </>
          )}
        </div>

        {/* Zone de saisie */}
        <div className="bg-white border-t border-gray-200 p-4">
          {replyTo && (
            <div className="flex items-center gap-2 mb-2 px-3 py-2 bg-blue-50 rounded-lg border-l-2 border-blue-400">
              <div className="flex-1 min-w-0">
                <p className="text-xs font-medium text-blue-600">RÃ©pondre Ã  {replyTo.senderName}</p>
                <p className="text-xs text-gray-600 truncate">{replyTo.content}</p>
              </div>
              <button onClick={() => setReplyTo(null)} className="text-gray-400 hover:text-gray-600 flex-shrink-0">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
            </div>
          )}
          <form onSubmit={sendMessage} className="flex items-end gap-2 relative">
            {showMentions && filteredMentions.length > 0 && (
              <div className="absolute bottom-full left-0 mb-2 w-56 bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden z-20">
                {filteredMentions.map((m, i) => (
                  <button key={m._id} type="button" onClick={() => insertMention(m)}
                    className={`w-full flex items-center gap-2.5 px-3 py-2 text-sm transition-colors ${i === mentionIndex ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-50'}`}>
                    <div className={`w-6 h-6 ${ROLE_COLORS[m.role] || 'bg-gray-400'} rounded-full flex items-center justify-center flex-shrink-0`}>
                      <span className="text-white text-[10px] font-bold">{(m.name || m.email || 'U').charAt(0).toUpperCase()}</span>
                    </div>
                    <span className="flex-1 text-left font-medium truncate">{m.name || m.email?.split('@')[0]}</span>
                    <span className="text-[10px] text-gray-400">{ROLE_LABELS[m.role] || ''}</span>
                  </button>
                ))}
              </div>
            )}
            <div className="flex-1 relative">
              <textarea
                ref={inputRef}
                value={newMessage}
                onChange={e => handleMentionInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder={`Message dans #${activeChannelObj?.name || activeChannel}... (@mention, EntrÃ©e pour envoyer)`}
                className="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none leading-relaxed"
                rows={1}
                style={{ minHeight: '42px', maxHeight: '120px' }}
                onInput={e => { e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px'; }}
              />
            </div>
            <button type="submit" disabled={!newMessage.trim() || sending}
              className="flex-shrink-0 w-10 h-10 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white rounded-xl flex items-center justify-center transition-colors">
              {sending ? (
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
              ) : (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
              )}
            </button>
          </form>
          <p className="text-[10px] text-gray-400 mt-1.5 ml-1">EntrÃ©e pour envoyer Â· Maj+EntrÃ©e pour nouvelle ligne Â· Ã‰chap pour annuler</p>
        </div>
        </>
        )}

      </div>

      {/* Modal nouveau canal */}
      {showNewChannel && (
        <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4" onClick={() => setShowNewChannel(false)}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
            <h3 className="text-lg font-semibold text-gray-900 mb-4">Nouveau canal</h3>
            <form onSubmit={createChannel} className="space-y-4">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Emoji</label>
                <div className="flex flex-wrap gap-1.5">
                  {EMOJIS.map(em => (
                    <button key={em} type="button" onClick={() => setNewChannelEmoji(em)}
                      className={`w-8 h-8 text-lg rounded-lg flex items-center justify-center transition-colors ${newChannelEmoji === em ? 'bg-blue-100 ring-2 ring-blue-500' : 'hover:bg-gray-100'}`}>{em}</button>
                  ))}
                </div>
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Nom du canal *</label>
                <input type="text" value={newChannelName} onChange={e => setNewChannelName(e.target.value)}
                  placeholder="ex: commandes, livraisons..."
                  className="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" autoFocus />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Description (optionnel)</label>
                <input type="text" value={newChannelDesc} onChange={e => setNewChannelDesc(e.target.value)}
                  placeholder="Ã€ quoi sert ce canal ?"
                  className="w-full px-3 py-2 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
              </div>
              <div className="flex gap-3 pt-2">
                <button type="button" onClick={() => setShowNewChannel(false)}
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-xl text-sm font-medium text-gray-700 hover:bg-gray-50">Annuler</button>
                <button type="submit" disabled={!newChannelName.trim() || creatingChannel}
                  className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white rounded-xl text-sm font-medium transition-colors">
                  {creatingChannel ? 'CrÃ©ation...' : 'CrÃ©er le canal'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
